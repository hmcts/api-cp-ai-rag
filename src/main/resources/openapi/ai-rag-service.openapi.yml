openapi: 3.0.0
servers:
  - description: APIHub API Auto Mocking AI RAG service APIs
    url: https://virtserver.swaggerhub.com/HMCTS-DTS/api-cp-ai-rag/0.0.0
info:
  title: RAG Service API
  version: 0.0.0
  description: API for RAG service for document ingestion and answer retrieval
  contact:
    email: no-reply@hmcts.com
  license:
    name: MIT
    url: 'https://opensource.org/licenses/MIT'
components:
  schemas:
    uuid:
      type: string
      pattern: ^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$
    metadataFilter:
      description: 'A key value pair object representing a filter value to be applied to the metadata of the ingested documents'
      type: object
      properties:
        key:
          type: string
          description: Key attribute representation
          maxLength: 1024
        value:
          type: string
          description: Value field representation
      required:
        - key
        - value

    documentIngestionStatusReturnedSuccessfully:
      description: 'Payload representing the response for successful document ingestion status retrieval'
      type: object
      properties:
        documentName:
          type: string
          description: Name of the document
          maxLength: 1024
        documentId:
          $ref: '#/components/schemas/uuid'
        status:
          type: string
          description: Status of the document ingestion
          enum:
            - INGESTION_SUCCESS
            - INGESTION_FAILED
            - METADATA_VALIDATED
            - INVALID_METADATA
        lastUpdated:
          type: string
          format: date-time
          description: Timestamp of the last update
        reason:
          type: string
          description: Reason for the current status, if applicable
      required:
        - documentName
        - documentId
        - status
        - lastUpdated
        - reason

    documentStatusNotAvailable:
      description: 'Payload representing the response when document not known to the service'
      type: object
      properties:
        documentName:
          type: string
          description: Name of the document
          maxLength: 1024
        reason:
          type: string
          description: Reason for the current status, if applicable
      required:
        - documentName
        - reason

    userQueryAnswerReturnedSuccessfullySynchronously:
      description: 'Payload representing the response for successful answer generation to user query'
      type: object
      properties:
        userQuery:
          type: string
          description: Query sent by the user
        llmResponse:
          type: string
          description: Response generated by the LLM
        queryPrompt:
          type: string
          description: Prompt used for querying the LLM
        chunkedEntries:
          type: array
          description: List of chunked entries used to generate the answer
          items:
            type: object
        responseGenerationTime:
          type: string
          format: date-time
          description: Timestamp of when the response was generated
        responseGenerationDuration:
          type: integer
          description: Time taken to generate the response in milliseconds
      required:
        - userQuery
        - llmResponse
        - queryPrompt
        - chunkedEntries

    userQueryAnswerReturnedSuccessfullyAsynchronously:
      description: 'Payload representing the response for successful answer generation to user query'
      type: object
      properties:
        transactionId:
          allOf:
            - $ref: '#/components/schemas/uuid'
            - description: Reference to lookup the status of the asynchronous request
        userQuery:
          type: string
          description: Query sent by the user
        llmResponse:
          type: string
          description: Response generated by the LLM
        queryPrompt:
          type: string
          description: Prompt used for querying the LLM
        chunkedEntries:
          type: array
          description: List of chunked entries used to generate the answer
          items:
            type: object
        responseGenerationTime:
          type: string
          format: date-time
          description: Timestamp of when the response was generated
        responseGenerationDuration:
          type: integer
          description: Time taken to generate the response in milliseconds
      required:
        - userQuery
        - llmResponse
        - queryPrompt
        - chunkedEntries
        - transactionId

    userQueryAnswerRequestAccepted:
      description: 'Payload representing the response for acceptance of answer generation to user query'
      type: object
      properties:
        transactionId:
          allOf:
            - $ref: '#/components/schemas/uuid'
            - description: Reference to lookup the status of the asynchronous request
      required:
        - transactionId

    requestErrored:
      description: 'Payload response for invalid user query answer request'
      type: object
      properties:
        errorMessage:
          type: string
          description: Error message detailing the issue
      required:
        - errorMessage

paths:
  /document-status:
    get:
      summary: Get document status
      description: Obtain status of document uploaded for ingestion into AI search service
      operationId: document-status
      tags:
        - Document ingestion status
      parameters:
        - name: document-name
          in: query
          required: true
          schema:
            type: string
            maxLength: 1024
          description: Name of the document to retrieve status for
      responses:
        '200':
          description: Document ingestion status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/documentIngestionStatusReturnedSuccessfully'
        '404':
          description: Document not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/documentStatusNotAvailable'

  /answer-user-query:
    post:
      summary: Generate response for user query synchronously
      description: Summarised response generated by the LLM based on the user query and ingested documents
      operationId: answer-user-query
      tags:
        - Document information summarised synchronously
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userQuery:
                  type: string
                queryPrompt:
                  type: string
                metadataFilter:
                  type: array
                  items:
                    $ref: '#/components/schemas/metadataFilter'
              required:
                - userQuery
                - queryPrompt
                - metadataFilters
      responses:
        '200':
          description: Answer returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/userQueryAnswerReturnedSuccessfullySynchronously'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/requestErrored'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/requestErrored'

  /answer-user-query-async:
    post:
      summary: Generate response for user query asynchronously
      description: Accept request for providing a summarised response for user query.  Response generation happens asynchronously.
      operationId: answer-user-query-async
      tags:
        - Document information summarised asynchronously
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userQuery:
                  type: string
                queryPrompt:
                  type: string
                metadataFilter:
                  type: array
                  items:
                    $ref: '#/components/schemas/metadataFilter'
              required:
                - userQuery
                - queryPrompt
                - metadataFilters
      responses:
        '202':
          description: Acceptance response returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/userQueryAnswerRequestAccepted'
        '400':
          description: Payload request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/requestErrored'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/requestErrored'

  /answer-user-query-status:
    get:
      summary: Check status of asynchronous request to provide summarised answer for user query
      description: Summarised response generated by the LLM based on the user query and ingested documents.  Response generation happens asynchronously.
      operationId: answer-user-query-status
      tags:
        - Document information summarised asynchronously
      parameters:
        - name: transactionId
          in: query
          required: true
          schema:
            allOf:
              - $ref: '#/components/schemas/uuid'
              -  description: Reference to lookup the status of the asynchronous request
          description: Name of the document to retrieve status for

      responses:
        '200':
          description: Answer returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/userQueryAnswerReturnedSuccessfullyAsynchronously'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/requestErrored'
